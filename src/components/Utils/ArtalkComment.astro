
---
let canonicalPath = Astro.url.pathname;
---

<!-- 1. 先静态显示阅读量/评论数的骨架屏 -->
<!-- <div class="flex justify-between items-center text-75 mb-4">
  <div class="flex items-center">
    阅读量: <span class="artalk-pv-count ml-1">--</span>
  </div>
  <div class="flex items-center">
    评论数：<span class="artalk-comment-count ml-1">--</span>
  </div>
</div> -->

<!-- 将服务器端生成的规范 pageKey 通过 data-* 属性传递给客户端 -->
<div id="Comments" data-page-key={canonicalPath}></div>

<script is:inline>
  function initArtalk() {
    const container = document.getElementById('Comments');
    if (!container) return;

    const pageKey = container.getAttribute('data-page-key');
    if (!pageKey) return;

    container.innerHTML = '';

    if (!document.querySelector('link[href="https://unpkg.com/artalk@2.9.1/dist/Artalk.css"]')) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/artalk@2.9.1/dist/Artalk.css';
      document.head.appendChild(link);
    }

    import('https://esm.sh/artalk@2.9.1').then(ArtalkModule => {
      const Artalk = ArtalkModule.default || ArtalkModule;
      Artalk.init({
        el: '#Comments',
        server: 'https://nav.blueke.top/',
        site: 'Nav',
        pageKey,
        pageTitle: document.title,
        locale: 'zh-CN',
        noComment: '快来评论吧！',
        darkMode: document.documentElement.classList.contains('dark'),
        avatar: {
          default: '/favicon.ico',
          gravatar: { mirror: 'https://cravatar.cn/avatar/' }
        }
      });
    });
  }

  // 兼容初始化：首屏就执行；若使用客户端导航，再监听 astro:page-load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initArtalk);
  } else {
    initArtalk();
  }
  document.addEventListener('astro:page-load', initArtalk);

  // 主题切换时重建（保留你原有逻辑）
  if (!window.artalkThemeObserver) {
    const observer = new MutationObserver(() => initArtalk());
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
    window.artalkThemeObserver = true;
  }
</script>