
---
let canonicalPath = Astro.url.pathname === '/' ? '/index' : Astro.url.pathname;
---

<div id="Comments" data-page-key={canonicalPath}></div>

<script is:inline>
  function initArtalk() {
    const container = document.getElementById('Comments');
    if (!container) return;

    const pageKey = container.getAttribute('data-page-key');
    if (!pageKey) return;

    container.innerHTML = '';

    const serverUrl = 'https://artalk.blueke.top/';

    const isNightMode = () => {
      const b = document.body.classList;
      const h = document.documentElement.classList;
      return (
        b.contains('dark') ||
        b.contains('night') ||
        b.contains('dark-mode') ||
        h.contains('dark') ||
        b.contains('io-black-mode')
      );
    };

    const tryConfigEndpoints = async () => {
      const endpoints = [
        `${serverUrl}api/v2/conf`,
        `${serverUrl}api/conf`,
      ];
      for (const url of endpoints) {
        try {
          const res = await fetch(url, { mode: 'cors' });
          if (res.ok) return true;
        } catch {}
      }
      return false;
    };

    tryConfigEndpoints().then(async ok => {
      if (!ok) {
        const container = document.getElementById('Comments');
        if (container) {
          container.innerHTML = '<div style="padding:8px;color:#b00;background:#fee;border:1px solid #f99;border-radius:6px;">Artalk 后端未就绪或地址错误，请检查 serverUrl 与反向代理配置</div>';
        }
        return;
      }

      if (!document.querySelector('link[href="https://unpkg.com/artalk@2.9.1/dist/Artalk.css"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/artalk@2.9.1/dist/Artalk.css';
        document.head.appendChild(link);
      }

      import('https://esm.sh/artalk@2.9.1').then(ArtalkModule => {
        const Artalk = ArtalkModule.default || ArtalkModule;

        const instance = Artalk.init({
          el: '#Comments',
          server: serverUrl,
          site: 'Nav',
          pageKey: container.getAttribute('data-page-key'),
          pageTitle: document.title,
          locale: 'zh-CN',
          noComment: '快来评论吧！',
          darkMode: isNightMode(),
          avatar: {
            default: '/favicon.ico',
            gravatar: { mirror: 'https://cravatar.cn/avatar/' }
          }
        });
        window.artalkInstance = instance;
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initArtalk);
  } else {
    initArtalk();
  }
  document.addEventListener('astro:page-load', initArtalk);

  if (!window.artalkThemeObserver) {
    const observer = new MutationObserver(() => initArtalk());
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
    window.artalkThemeObserver = true;
  }
</script>

<style is:global>
  /* 暗色：基于 io-black-mode（你的站点暗色类）覆盖 Artalk 编辑器输入区 */
  body.io-black-mode #Comments .atk-editor,
  html.dark #Comments .atk-editor {
    background-color: #111827 !important; /* slate-900 */
    border-color: #374151 !important;     /* gray-700 */
    color: #e5e7eb !important;            /* gray-200 */
  }

  body.io-black-mode #Comments .atk-editor textarea,
  body.io-black-mode #Comments .atk-editor input[type="text"],
  body.io-black-mode #Comments .atk-editor input[type="email"],
  body.io-black-mode #Comments .atk-editor .atk-input,
  body.io-black-mode #Comments .atk-editor .atk-textarea,
  body.io-black-mode #Comments .atk-editor .form-control,
  html.dark #Comments .atk-editor textarea,
  html.dark #Comments .atk-editor input[type="text"],
  html.dark #Comments .atk-editor input[type="email"],
  html.dark #Comments .atk-editor .atk-input,
  html.dark #Comments .atk-editor .atk-textarea,
  html.dark #Comments .atk-editor .form-control {
    background-color: #1f2937 !important; /* gray-800 */
    color: #e5e7eb !important;            /* gray-200 */
    border-color: #374151 !important;     /* gray-700 */
    box-shadow: none !important;
  }

  body.io-black-mode #Comments .atk-editor textarea::placeholder,
  body.io-black-mode #Comments .atk-editor input::placeholder,
  html.dark #Comments .atk-editor textarea::placeholder,
  html.dark #Comments .atk-editor input::placeholder {
    color: #9aa0a6 !important; /* 更浅的 placeholder */
    opacity: 1 !important;
  }

  body.io-black-mode #Comments .atk-editor button,
  body.io-black-mode #Comments .atk-editor .atk-send,
  html.dark #Comments .atk-editor button,
  html.dark #Comments .atk-editor .atk-send {
    background-color: #374151 !important; /* gray-700 */
    color: #e5e7eb !important;
    border-color: #4b5563 !important;     /* gray-600 */
  }

  body.io-black-mode #Comments .atk-editor button:hover,
  body.io-black-mode #Comments .atk-editor .atk-send:hover,
  html.dark #Comments .atk-editor button:hover,
  html.dark #Comments .atk-editor .atk-send:hover {
    background-color: #4b5563 !important; /* gray-600 */
    border-color: #6b7280 !important;     /* gray-500 */
  }

  /* 提升可读性：标签/提示文字 */
  body.io-black-mode #Comments .atk-editor label,
  body.io-black-mode #Comments .atk-editor .atk-editor__header,
  html.dark #Comments .atk-editor label,
  html.dark #Comments .atk-editor .atk-editor__header {
    color: #cbd5e1 !important; /* slate-300 */
  }
</style>