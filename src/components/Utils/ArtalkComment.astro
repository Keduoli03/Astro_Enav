
---
let canonicalPath = Astro.url.pathname === '/' ? '/index' : Astro.url.pathname;
---

<div id="Comments" data-page-key={canonicalPath}></div>

<script is:inline>
  function initArtalk() {
    const container = document.getElementById('Comments');
    if (!container) return;

    const pageKey = container.getAttribute('data-page-key');
    if (!pageKey) return;

    container.innerHTML = '';

    // 请改为你的真实 Artalk 后端根路径
    // 如果你通过子路径反向代理，请用类似 'https://nav.blueke.top/artalk/'
    // 如果是独立域名，请用类似 'https://artalk.blueke.top/'
    const serverUrl = 'https://artalk.blueke.top/'; // 确保是你的 Artalk 后端地址

    const isNightMode = () => {
      const b = document.body.classList;
      const h = document.documentElement.classList;
      return (
        b.contains('dark') ||
        b.contains('night') ||
        b.contains('dark-mode') ||
        h.contains('dark')
      );
    };

    const tryConfigEndpoints = async () => {
      const endpoints = [
        `${serverUrl}api/v2/conf`, // 正确的配置接口
        `${serverUrl}api/conf`,    // 兼容旧版本
      ];
      for (const url of endpoints) {
        try {
          const res = await fetch(url, { mode: 'cors' });
          if (res.ok) return true;
        } catch {}
      }
      return false;
    };

    tryConfigEndpoints().then(async ok => {
      if (!ok) {
        console.error('Artalk 服务端不可用或路径错误：', serverUrl);
        const container = document.getElementById('Comments');
        if (container) {
          container.innerHTML = '<div style="padding:8px;color:#b00;background:#fee;border:1px solid #f99;border-radius:6px;">Artalk 后端未就绪或地址错误，请检查 serverUrl 与反向代理配置</div>';
        }
        return;
      }

      if (!document.querySelector('link[href="https://unpkg.com/artalk@2.9.1/dist/Artalk.css"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/artalk@2.9.1/dist/Artalk.css';
        document.head.appendChild(link);
      }

      import('https://esm.sh/artalk@2.9.1').then(ArtalkModule => {
        const Artalk = ArtalkModule.default || ArtalkModule;

        // 初始化并记录实例
        const instance = Artalk.init({
          el: '#Comments',
          server: serverUrl,
          site: 'Nav',
          pageKey: container.getAttribute('data-page-key'),
          pageTitle: document.title,
          locale: 'zh-CN',
          noComment: '快来评论吧！',
          darkMode: isNightMode(),
          avatar: {
            default: '/favicon.ico',
            gravatar: { mirror: 'https://cravatar.cn/avatar/' }
          }
        });
        window.artalkInstance = instance;
      });
    });
  }

  // 首屏执行 + 客户端导航兼容
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initArtalk);
  } else {
    initArtalk();
  }
  document.addEventListener('astro:page-load', initArtalk);

  // 主题切换时重建
  if (!window.artalkThemeObserver) {
    const observer = new MutationObserver(() => initArtalk());
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
    window.artalkThemeObserver = true;
  }

  // 主题切换适配（优先无刷新切换，回退重建）
  if (!window.artalkThemeObserver) {
    const applyTheme = () => {
      const isDark = (
        document.body.classList.contains('dark') ||
        document.body.classList.contains('night') ||
        document.body.classList.contains('dark-mode') ||
        document.documentElement.classList.contains('dark')
      );
      if (window.artalkInstance && typeof window.artalkInstance.setDarkMode === 'function') {
        window.artalkInstance.setDarkMode(isDark);
      } else {
        // 旧版本或无 setDarkMode 时，回退重建
        initArtalk();
      }
    };
    new MutationObserver(applyTheme).observe(document.body, {
      attributes: true,
      attributeFilter: ['class']
    });
    new MutationObserver(applyTheme).observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class']
    });
    window.artalkThemeObserver = true;
  }
</script>