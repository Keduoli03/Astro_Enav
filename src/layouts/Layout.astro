---
// src/layouts/Layout.astro
import Sidebar from '../components/Sidebar.astro';
import Header from '../components/Header.astro';
import Search from '../components/Search.astro';
import Footer from '../components/Footer.astro';
import { SITE_DESCRIPTION, SITE_FAVICON, SITE_TITLE,SITE_BG } from '../settings';
import { LIGHT_MODE, DARK_MODE, AUTO_MODE, DEFAULT_THEME } from '../constants/constants';
import '../styles/global.css';
---
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <link rel="preload" href="/css/block-library.min-5.6.2.css" as="style">
  <link rel="stylesheet" href="/css/iconfont-3.03029.1.css" type="text/css" media="all" />
  <link rel="stylesheet" href="/css/bootstrap.min-4.3.1.css" type="text/css" media="all" />
  <link rel="stylesheet" href="/css/style-3.03029.1.css" type="text/css" media="all" />
  <link rel="preload" href="/css/block-library.min-5.6.2.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="/fontawesome-5.15.4/css/all.min.css" type="text/css" />
  
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#f9f9f9" />
  <link rel="sitemap" href="/sitemap-index.xml" />
  <title>{SITE_TITLE}</title>
  <link rel="shortcut icon" href={SITE_FAVICON} />
  <meta name="keywords" content={SITE_TITLE} />
  <meta name="description" content={SITE_DESCRIPTION} />

  <!-- 防止FOUC的内联样式 - 必须在CSS加载前定义 -->
  <style>
    /* 防止白色闪烁的关键样式 */
    body.io-black-mode {
      background-color: #1b1d1f !important;
      color: #c6c9cf !important;
    }
    body.io-grey-mode {
      background-color: #f9f9f9 !important;
      color: #282a2d !important;
    }
    /* 确保过渡动画 */
    body {
      transition: background-color 0.3s ease, color 0.3s ease;
    }
  </style>

  <!-- 防止FOUC的主题初始化脚本 - 与LightDarkSwitch.svelte保持一致 -->
  <script is:inline define:vars={{DEFAULT_THEME, LIGHT_MODE, DARK_MODE, AUTO_MODE}}>
    (function() {
      // 使用与theme-utils.ts相同的逻辑
      function getStoredTheme() {
        const stored = localStorage.getItem('theme');
        return stored || DEFAULT_THEME;
      }
      
      function applyThemeToDocument(theme) {
        // 立即应用到body，不等待DOM加载
        const body = document.body || document.getElementsByTagName('body')[0];
        if (body) {
          // 移除现有的主题类
          body.classList.remove('io-grey-mode', 'io-black-mode');
          
          // 应用新的主题类
          switch (theme) {
            case LIGHT_MODE:
              body.classList.add('io-grey-mode');
              break;
            case DARK_MODE:
              body.classList.add('io-black-mode');
              break;
            case AUTO_MODE:
              if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                body.classList.add('io-black-mode');
              } else {
                body.classList.add('io-grey-mode');
              }
              break;
          }
        }
      }
      
      // 立即应用存储的主题
      const storedTheme = getStoredTheme();
      // 如果存储的是AUTO_MODE，LightDarkSwitch会默认设为LIGHT_MODE
      const theme = (storedTheme === LIGHT_MODE || storedTheme === DARK_MODE) ? storedTheme : LIGHT_MODE;
      
      // 立即尝试应用主题
      applyThemeToDocument(theme);
      
      // 如果body还不存在，监听DOM变化
      if (!document.body) {
        const observer = new MutationObserver(function(mutations) {
          if (document.body) {
            observer.disconnect();
            applyThemeToDocument(theme);
          }
        });
        observer.observe(document.documentElement, { childList: true, subtree: true });
      }
    })();
  </script>
  
  <script type="text/javascript" src="/js/jquery.min-3.2.1.js" id="jquery-js"></script>
  <script src="/js/content-search.js" defer id="content-search-js"></script>
</head>

<body class="page-loading">
<div class="page-container">
  <Sidebar />
  <div class="main-content flex-fill grid-bg"> 
    <Header />
    <Search />
    <div id="content" class="content-site customize-site">
      <slot />
    </div>
    <Footer />
  </div>
</div>
</body>
</html>
