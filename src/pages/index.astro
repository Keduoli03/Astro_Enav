---
import Sidebar from '../components/Sidebar.astro';
import Header from '../components/Header.astro';
import Search from '../components/Search.astro';
import Footer from '../components/Footer.astro';

import CategorySection from '../components/CategorySection.astro';
import { getCategoryName, getCategoryIcon } from '../data/category';
import { SITE_DESCRIPTION, SITE_FAVICON, SITE_TITLE } from '../settings';
// 动态加载分类数据
const categoryFiles = import.meta.glob('../data/sites/*.js');
const categories = Object.keys(categoryFiles).map(path => {
  const fileName = path.split('/').pop(); // 可能是 undefined
  return fileName?.replace('.js', '') ?? ''; // 安全处理
}).filter(Boolean);
const categoryData = await Promise.all(
  categories.map(async (category) => ({
    name: category,
    displayName: getCategoryName(category), 
    icon: getCategoryIcon(category),
    sites: (await import(`../data/sites/${category}.js`)).default
  }))
);
---
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<style id="critical-css" type="text/css">
    /* 加载动画核心样式 */
    body {
      margin: 0;
      overflow: hidden; /* 初始隐藏内容 */
    }
    body.page-loading {
      position: relative;
    }
    body.page-loading::before,
    body.page-loading::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      transition: opacity 0.5s ease-out;
    }
    body.page-loading::before {
      /* 优化：根据主题动态调整背景色 */
      background: var(--loading-bg, #f9f9f9);
      opacity: 1;
    }
    body.page-loading::after {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      border: 5px solid var(--loading-border, rgba(0, 0, 0, 0.15));
      border-top-color: var(--loading-border-top, #333);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* 加载完成后样式 */
    body.page-loaded {
      overflow: auto; /* 恢复滚动 */
    }
    body.page-loaded::before,
    body.page-loaded::after {
      opacity: 0;
      pointer-events: none;
    }
    
    /* 主题变量 - 优化加载动画颜色 */
    body.io-grey-mode {
      --bg-color: #f9f9f9;
      --loading-bg: #f9f9f9;
      --loading-border: rgba(0, 0, 0, 0.15);
      --loading-border-top: #333;
    }
    body.io-black-mode {
      --bg-color: #222;
      --loading-bg: #222;
      --loading-border: rgba(255, 255, 255, 0.15);
      --loading-border-top: #fff;
    }
  </style>
  
  <meta charset="UTF-8" />
  <style id="initial-theme">
    body.io-grey-mode { background-color: #f9f9f9; }
    body.io-black-mode { background-color: #222; }
  </style>
  <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#f9f9f9" />
  <title>{SITE_TITLE}</title>
  <link rel="shortcut icon" href={SITE_FAVICON} />
  <meta name="keywords" content={SITE_TITLE} />
  <meta name="description" content={SITE_DESCRIPTION} />

  <!-- 预加载关键资源 -->
  <link rel="preload" href="/css/block-library.min-5.6.2.css" as="style">

  <link rel="stylesheet" href="/css/iconfont-3.03029.1.css" type="text/css" media="all" />
  <link rel="stylesheet" href="/css/bootstrap.min-4.3.1.css" type="text/css" media="all" />
  <link rel="stylesheet" href="/css/style-3.03029.1.css" type="text/css" media="all" />
  <link rel="stylesheet" href="/css/custom-style.css" type="text/css" media="all" />
  <link rel="stylesheet" href="/fontawesome-5.15.4/css/all.min.css" type="text/css" />
  
  <script type="text/javascript" src="/js/jquery.min-3.2.1.js" id="jquery-js"></script>
  <script src="/js/content-search.js" defer id="content-search-js"></script>
</head>

<body class="io-grey-mode page-loading">
<div class="page-container">
  <Sidebar />
  <div class="main-content flex-fill grid-bg"> 
    <Header />
    <Search />
    <div id="content" class="content-site customize-site">
      {categoryData.map(({ name, displayName, icon, sites }) => (
        <CategorySection 
          category={name}
          displayName={displayName} 
          icon={icon}              
          sites={sites}
        />
      ))}
    </div>
    <Footer />
  </div>
</div>

 <script type="text/javascript" src="/js/night-mode.js"></script>
</body>
</html>